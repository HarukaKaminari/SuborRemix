C51 COMPILER V9.52.0.0   I2C                                                               04/08/2018 17:15:52 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN I2C.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE I2C.c LARGE OPTIMIZE(9,SPEED) BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <INTRINS.h>
   2          #include <stdio.h>
   3          #include "I2C.h"
   4          #include <CH559.h>
   5          #include "GPIO.h"
   6          
   7          
   8          /*
   9                  I2C.c
  10                  ׼80C51ƬģI2Cߵ
  11                  ѧϰοṩκοɿԷĵҵĿ
  12          ˵
  13                  һC51ģI2CЭľ汾
  14                  ֻһģʽǶģʽ
  15                  I2CЭеʱͬ
  16                  Ҫ˽ⱾϸڣοPhilips˾Э׼
  17          ÷
  18                  1. ļI2C.hI2C.cһƵĹļ
  19                  2. ʵʵƬͺţSFRͷļ<reg52.h>
  20                  3. ʵʵ·޸I2CźSCLSDAĶ
  21                  4. ͨ궨I2C_DELAY_VALUEI2CߵٶʹʵҪ
  22                  5. ļI2C.cӽУҪĵطͷļI2C.h
  23                  6. main()ĿʼҪһγʼI2C_Init()
  24                  7. I2C_Puts()I2C_Gets()I2Cۺ϶д뿴עͺʹ
  25                  8. ȫʵıʶI2C_ͷЧͻ
  26                  9. ע⣺ӻַ7λַʾдλλЧ
  27          */
  28          
  29          // I2CʱӵʱֵҪʵ޸ģȡֵ1255
  30          // 1TƬ@30MHzƵ£ֻҪֵ33ôʱʱͳ4.7uS
  31          // ǵ1TƬIOڿӦĸı䣬ԼݺͷֲɵĲαԵֵͣӦԴ
             -ڼֵ
  32          #define I2C_DELAY_VALUE         64
  33          
  34          // I2Cֹͣһοʼ֮ǰĵȴʱ䣬ȡֵ165535
  35          // ȴʱΪ(I2C_STOP_WAIT_VALUE*5)/ƵuS
  36          // ڶȡֵΪ1ɣĳЩ˵ϳʱǱ
  37          #define I2C_STOP_WAIT_VALUE             1
  38          
  39          // I2CȴӻӦĳʱʱ䣬ȡֵ1~65535
  40          #define I2C_WAIT_ACK_TIMEOUT    255
  41          
  42          
  43          // ģI2CߵŶ
  44          sbit I2C_SCL = P0^2;
  45          sbit I2C_SDA = P0^3;
  46          
  47          
  48          /*
  49          I2C_Delay()
  50          ܣʱģI2Cר
  51          ˵ʱʱΪ((6+2+I2C_DELAY_VALUE*4+4)/Ƶ)uS
  52          */
  53          static void I2C_Delay() small{
  54   1              u8 I2C_Delay_t = (I2C_DELAY_VALUE);
C51 COMPILER V9.52.0.0   I2C                                                               04/08/2018 17:15:52 PAGE 2   

  55   1              while(--I2C_Delay_t != 0);
  56   1      }
  57          
  58          /*
  59          I2C_Init()
  60          ܣI2C߳ʼʹߴڿ״̬
  61          ˵main()ĿʼͨӦҪִһα
  62          */
  63          void I2C_Init() small{
  64   1              // I2C_SCLI2C_SDAóɿ©
  65   1              GPIO_SelMode(0, 5, 2);
  66   1              GPIO_SelMode(0, 5, 3);
  67   1              
  68   1              I2C_SCL = 1;
  69   1              I2C_Delay();
  70   1              I2C_SDA = 1;
  71   1              I2C_Delay();
  72   1      }
  73          
  74          /*
  75          I2C_Start()
  76          ܣI2Cߵʼ״̬
  77          ˵
  78                  SCLڸߵƽڼ䣬SDA½ʱI2C
  79                  SDASCLʲôƽ״̬ȷʼ״̬
  80                  Ҳظʼ״̬
  81                  ִкI2Cߴæ״̬
  82          */
  83          void I2C_Start() small{
  84   1              I2C_SDA = 1;
  85   1              I2C_Delay();
  86   1              I2C_SCL = 1;
  87   1              I2C_Delay();
  88   1              I2C_SDA = 0;
  89   1              I2C_Delay();
  90   1              I2C_SCL = 0;
  91   1              I2C_Delay();
  92   1      }
  93          
  94          /*
  95          I2C_Write()
  96          ܣI2Cд1ֽڵ
  97          
  98                  datҪдϵ
  99          */ 
 100          void I2C_Write(u8 dat) small{
 101   1              u8 t = 8;
 102   1              do{
 103   2                      I2C_SDA = (bit)(dat & 0x80);
 104   2                      I2C_Delay();
 105   2                      I2C_SCL = 1;
 106   2                      I2C_Delay();
 107   2                      I2C_SCL = 0;
 108   2                      I2C_Delay();
 109   2                      dat <<= 1;
 110   2              }while(--t != 0);
 111   1      }
 112          
 113          /*
 114          I2C_Read()
 115          ܣӴӻȡ1ֽڵ
 116          أȡһֽ
C51 COMPILER V9.52.0.0   I2C                                                               04/08/2018 17:15:52 PAGE 3   

 117          */
 118          u8 I2C_Read() small{
 119   1              u8 dat;
 120   1              u8 t = 8;
 121   1              I2C_SDA = 1;    // ڶȡ֮ǰҪSDA
 122   1              I2C_Delay();
 123   1              do{
 124   2                      I2C_SCL = 1;            // ͷSCLߣȴӻ
 125   2                      I2C_Delay();
 126   2                      while(!I2C_SCL);        // ȴӻͷSCLӻͷSCLӻѾSDA׼ã̶ȡ
 127   2                      dat <<= 1;
 128   2                      dat |= I2C_SDA;
 129   2                      I2C_SCL = 0;
 130   2                      I2C_Delay();
 131   2              }while(--t != 0);
 132   1              return dat;
 133   1      }
 134          
 135          /*
 136          I2C_GetAck()
 137          ܣȡӻӦλ
 138          أ
 139                  0ӻӦ
 140                  1ӻӦ
 141          ˵
 142                  ӻյϵĵַԼĵַͬӦλ
 143                  ӻյÿֽڵݺҪӦλ
 144                  ӻյ1ֽڵݺһҪӦλ
 145          */
 146          bit I2C_GetAck() small{
 147   1              u16 timeout = I2C_WAIT_ACK_TIMEOUT;
 148   1              I2C_SDA = 1;
 149   1              I2C_Delay();
 150   1              I2C_SCL = 1;
 151   1              I2C_Delay();
 152   1              while(I2C_SDA){
 153   2                      timeout--;
 154   2                      if(timeout==0){
 155   3                              //printf("Not Acknowledged.\r\n");
 156   3                              return 1;
 157   3                      }
 158   2              }
 159   1              I2C_SCL = 0;
 160   1              I2C_Delay();
 161   1              return 0;
 162   1      }
 163          
 164          /*
 165          I2C_PutAck()
 166          ܣӦλӦλ
 167          
 168                  ack=0Ӧλ
 169                  ack=1Ӧλ
 170          ˵
 171                  ڽÿһֽڵݺ󣬶ӦӦλ
 172                  ڽһֽڵݺӦӦλ
 173          */
 174          void I2C_PutAck(bit ack) small{
 175   1              I2C_SDA = ack;
 176   1              I2C_Delay();
 177   1              I2C_SCL = 1;
 178   1              I2C_Delay();
C51 COMPILER V9.52.0.0   I2C                                                               04/08/2018 17:15:52 PAGE 4   

 179   1              I2C_SCL = 0;
 180   1              I2C_Delay();
 181   1      }
 182          
 183          /*
 184          I2C_Stop()
 185          ܣI2Cߵֹͣ״̬
 186          ˵
 187                  SCLڸߵƽڼ䣬SDAʱֹͣI2C
 188                  SDASCLʲôƽ״̬ȷֹͣ״̬
 189                  ִкI2Cߴڿ״̬
 190          */
 191          void I2C_Stop() small{
 192   1              u16 t = I2C_STOP_WAIT_VALUE;
 193   1              I2C_SDA = 0;
 194   1              I2C_Delay();
 195   1              I2C_SCL = 1;
 196   1              I2C_Delay();
 197   1              I2C_SDA = 1;
 198   1              I2C_Delay();
 199   1              while(--t != 0);        // һβStart֮ǰҪһʱ
 200   1      }
 201          
 202          /*
 203          CheckI2CSlaveValidity()
 204          ܣеI2CϷַ
 205          ˵
 206                  ͼдַӦ˵Ϸ
 207          */
 208          void CheckI2CSlaveValidity() small{
 209   1              u8 i = 0;
 210   1              printf("Start checking slaves!\r\n");
 211   1              I2C_Init();
 212   1              while(1){
 213   2                      bit result;
 214   2                      I2C_Start();
 215   2                      I2C_Write(i);
 216   2                      result = I2C_GetAck();
 217   2                      if(result == 0){
 218   3                              printf("Slave %d is valid.\r\n", (int)i);
 219   3                      }
 220   2                      I2C_Stop();
 221   2                      i++;
 222   2                      if(i == 0)break;
 223   2              }
 224   1              printf("Finished checking slaves!\r\n");
 225   1      }
 226          
 227          /*
 228          I2C_Puts()
 229          ܣI2CۺϷͺӻͶֽڵ
 230          
 231                  SlaveAddrӻַ7λַдλ
 232                  SubAddrӻӵַ
 233                  SubModӵַģʽ0ӵַ1ֽӵַ2˫ֽӵַ
 234                  *datҪ͵
 235                  Sizeݵֽ
 236          أ
 237                  0ͳɹ
 238                  1ڷ͵ַг쳣
 239                  -1ڷݹг쳣
 240          ˵
C51 COMPILER V9.52.0.0   I2C                                                               04/08/2018 17:15:52 PAGE 5   

 241                  ܹܺõӦгI2CǷӵַ
 242                  ӻûӵַʱSubAddr⣬SubModӦΪ0
 243          */
 244          s8 I2C_Puts(u8 SlaveAddr, u16 SubAddr, u8 SubMod, u8* dat, u16 Size) small{
 245   1              // ʱ
 246   1              u8 i;
 247   1              u8 a[3];
 248   1              // 鳤
 249   1              if(Size == 0)return 0;
 250   1              // ׼ӻַ
 251   1              a[0] = (SlaveAddr << 1);
 252   1              // ӵַģʽ
 253   1              if(SubMod > 2)SubMod = 2;
 254   1              // ȷӵַ
 255   1              switch(SubMod){
 256   2              case 0:
 257   2                      break;
 258   2              case 1:
 259   2                      a[1] = (u8)(SubAddr & 0xFF);
 260   2                      break;
 261   2              case 2:
 262   2                      a[1] = (u8)((SubAddr >> 8) & 0xFF);
 263   2                      a[2] = (u8)(SubAddr & 0xFF);
 264   2                      break;
 265   2              default:
 266   2                      break;
 267   2              }
 268   1              // ʹӻַŷӵַӵַĻ
 269   1              SubMod++;
 270   1              I2C_Start();
 271   1              for(i=0;i<SubMod;++i){
 272   2                      I2C_Write(a[i]);
 273   2                      if(I2C_GetAck()){
 274   3                              I2C_Stop();
 275   3                              return 1;
 276   3                      }
 277   2              }
 278   1              // 
 279   1              do{
 280   2                      I2C_Write(*dat++);
 281   2                      if(I2C_GetAck())break;
 282   2              }while(--Size != 0);
 283   1              // ϣֹͣI2Cߣؽ
 284   1              I2C_Stop();
 285   1              if(Size == 0){ 
 286   2                      return 0;
 287   2              }else{
 288   2                      return -1;
 289   2              }
 290   1      }
 291          
 292          /*
 293          I2C_Gets()
 294          ܣI2CۺϽպӴӻնֽڵ
 295          
 296                  SlaveAddrӻַ7λַдλ
 297                  SubAddrӻӵַ
 298                  SubModӵַģʽ0ӵַ1ֽӵַ2˫ֽӵַ
 299                  *datյ
 300                  Sizeݵֽ
 301          أ
 302                  0ճɹ
C51 COMPILER V9.52.0.0   I2C                                                               04/08/2018 17:15:52 PAGE 6   

 303                  1ڽչ̵ķ͵ַʱ쳣
 304          ˵
 305                  ܹܺõӦгI2CǷӵַ
 306                  ӻûӵַʱSubAddr⣬SubModӦΪ0
 307          */
 308          s8 I2C_Gets(u8 SlaveAddr, u16 SubAddr, u8 SubMod, u8* dat, u16 Size) small{
 309   1              // ʱ
 310   1              u8 i;
 311   1              u8 a[3];
 312   1              // 鳤
 313   1              if(Size == 0)return 0;
 314   1              // ׼ӻַ
 315   1              a[0] = (SlaveAddr << 1);
 316   1              // ӵַģʽ
 317   1              if(SubMod > 2)SubMod = 2;
 318   1              // ӵַĴӻҪȷʹӻַӵַ
 319   1              if(SubMod != 0){
 320   2                      //ȷӵַ
 321   2                      if(SubMod == 1){
 322   3                              a[1] = (u8)(SubAddr & 0xFF);
 323   3                      }else{
 324   3                              a[1] = (u8)((SubAddr >> 8) & 0xFF);
 325   3                              a[2] = (u8)(SubAddr & 0xFF);
 326   3                      }
 327   2                      // ʹӻַŷӵַ
 328   2                      SubMod++;
 329   2                      I2C_Start();
 330   2                      for(i=0;i<SubMod;++i){
 331   3                              I2C_Write(a[i]);
 332   3                              if(I2C_GetAck()){
 333   4                                      I2C_Stop();
 334   4                                      return 1;
 335   4                              }
 336   3                      }
 337   2              }
 338   1              // I2C_Start()ӵַĴӻظʼ״̬
 339   1              // ӵַĴӻʼ״̬
 340   1              I2C_Start();
 341   1              // ʹӻַ
 342   1              I2C_Write(a[0] + 1);
 343   1              if(I2C_GetAck()){
 344   2                      I2C_Stop();
 345   2                      return 1;
 346   2              }
 347   1              // 
 348   1              for(;;){
 349   2                      *dat++ = I2C_Read();
 350   2                      if(--Size == 0){
 351   3                              I2C_PutAck(1);
 352   3                              break;
 353   3                      }
 354   2                      I2C_PutAck(0);
 355   2              }
 356   1              // ϣֹͣI2Cߣؽ
 357   1              I2C_Stop();
 358   1              return 0;
 359   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    497    ----
   CONSTANT SIZE    =     74    ----
C51 COMPILER V9.52.0.0   I2C                                                               04/08/2018 17:15:52 PAGE 7   

   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      25
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
